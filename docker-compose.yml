services:
  source-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: source-db
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${SA_PASSWORD}
      MSSQL_PID: Developer
      MSSQL_AGENT_ENABLED: "true"
    ports:
      - "14331:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P \"$${MSSQL_SA_PASSWORD}\" -Q \"SELECT 1\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    volumes:
      - source-db-data:/var/opt/mssql

  serving-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: serving-db
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${SA_PASSWORD}
      MSSQL_PID: Developer
    ports:
      - "14332:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P \"$${MSSQL_SA_PASSWORD}\" -Q \"SELECT 1\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    volumes:
      - serving-db-data:/var/opt/mssql

  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pipeline
    depends_on:
      source-db:
        condition: service_healthy
      serving-db:
        condition: service_healthy
    environment:
      SA_PASSWORD: ${SA_PASSWORD}
      SOURCE_DSN: ${SOURCE_DSN}
      SERVING_DSN: ${SERVING_DSN}
      POLL_INTERVAL_SECONDS: ${POLL_INTERVAL_SECONDS}
      CDC_BATCH_MAX_ROWS: ${CDC_BATCH_MAX_ROWS}
      PROJECTION_INTERVAL_SECONDS: ${PROJECTION_INTERVAL_SECONDS}
      PROJECTION_RECOMPUTE_WINDOW_MINUTES: ${PROJECTION_RECOMPUTE_WINDOW_MINUTES}
      ENABLE_PROJ_ORDERS_KPI: ${ENABLE_PROJ_ORDERS_KPI}
      ENABLE_PROJ_ORDERS_LATEST: ${ENABLE_PROJ_ORDERS_LATEST}
      LOG_LEVEL: ${LOG_LEVEL}
    restart: unless-stopped

volumes:
  source-db-data:
  serving-db-data:
